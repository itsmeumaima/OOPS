{% extends "core/base.html" %}

{% block title %}Color Detector - Vision Accessibility Tools{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Header Section -->
  <div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <div class="flex justify-between items-center">
      <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">
        <i class="fas fa-arrow-left mr-2"></i>
        <span>Back to Dashboard</span>
      </a>
      
      <div class="text-center">
        <h2 class="text-2xl font-bold text-neutral-900 flex items-center justify-center gap-2">
          <i class="fas fa-palette text-primary-600"></i>
          Color Detector
        </h2>
        <p class="text-neutral-600">Upload an image and click anywhere to detect the color at that point</p>
      </div>
      
      <div></div> <!-- Empty div for spacing -->
    </div>
  </div>

  <!-- Upload Section -->
  <div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-neutral-900 mb-4">Upload Image</h3>
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      <div class="mb-4">
        <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-neutral-700 mb-2">Select Image</label>
        {{ form.image }}
      </div>
      <button type="submit" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">
        <i class="fas fa-cloud-upload-alt mr-2"></i>
        <span>Upload Image</span>
      </button>
    </form>
  </div>

  {% if image_url %}
  <!-- Image Section -->
  <div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <div class="bg-gradient-to-r from-primary-50 to-accent-50 border-l-4 border-primary-500 p-4 mb-6 rounded-r-lg">
      <div class="flex items-start">
        <i class="fas fa-info-circle text-primary-500 mt-1 mr-3"></i>
        <div>
          <h4 class="font-medium text-neutral-900">Instructions</h4>
          <p class="text-sm text-neutral-600">Click anywhere on the image below to detect the color at that point</p>
        </div>
      </div>
    </div>
    
    <h3 class="text-lg font-semibold text-neutral-900 mb-4 text-center">Click on the image to detect color</h3>
    <div class="flex justify-center">
      <img id="image" src="{{ image_url }}" alt="Uploaded Image" class="max-w-full h-auto rounded-lg shadow-md hover:shadow-xl transition-all duration-300 cursor-crosshair">
    </div>
  </div>
  {% endif %}

  <!-- Result Section -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <div id="result" style="display:none;">
      <h3 class="text-xl font-bold text-neutral-900 mb-6 text-center flex items-center justify-center gap-2">
        <i class="fas fa-eye text-primary-600"></i>
        Detected Color
      </h3>
      
      <div class="flex flex-col items-center mb-8">
        <div class="color-preview w-32 h-32 rounded-full border-4 border-neutral-200 shadow-md mb-4"></div>
        <h4 id="colorName" class="text-xl font-semibold text-neutral-900"></h4>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
        <div class="bg-gradient-to-br from-neutral-50 to-primary-50 rounded-xl p-5 border border-neutral-200 shadow-sm">
          <h5 class="font-semibold text-neutral-900 mb-3 flex items-center gap-2">
            <i class="fas fa-circle-half-stroke text-primary-600"></i>
            RGB Value
          </h5>
          <div class="color-value font-mono text-lg font-medium text-neutral-800" id="rgbValue"></div>
        </div>
        
        <div class="bg-gradient-to-br from-neutral-50 to-accent-50 rounded-xl p-5 border border-neutral-200 shadow-sm">
          <h5 class="font-semibold text-neutral-900 mb-3 flex items-center gap-2">
            <i class="fas fa-hashtag text-accent-600"></i>
            HEX Value
          </h5>
          <div class="color-value font-mono text-lg font-medium text-neutral-800" id="hexValue"></div>
        </div>
      </div>
      
      <div class="text-center mt-8">
        <button class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300" onclick="copyToClipboard()">
          <i class="fas fa-clipboard mr-2"></i>
          <span>Copy HEX Value</span>
        </button>
      </div>
    </div>
    
    <div id="noResult" class="text-center py-12">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 mb-4">
        <i class="fas fa-image text-primary-600 text-2xl"></i>
      </div>
      <p class="text-neutral-600">Upload an image and click on it to detect colors</p>
    </div>
    
    <div class="loading" id="loading" style="display:none;">
      <div class="flex flex-col items-center justify-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
        <p class="text-neutral-700">Detecting color...</p>
      </div>
    </div>
  </div>
</div>

<style>
  .color-preview { 
    transition: transform 0.3s;
  }
  
  .color-preview:hover {
    transform: scale(1.1);
  }
  
  input[type="file"] {
    display: block;
    width: 100%;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  input[type="file"]:focus {
    color: #495057;
    background-color: #fff;
    border-color: #0ea5e9;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(14, 165, 233, 0.25);
  }
</style>

<script>
const img = document.getElementById('image');
if (img) {
  img.addEventListener('click', function(e) {
    const rect = img.getBoundingClientRect();
    const x = Math.floor(e.clientX - rect.left);
    const y = Math.floor(e.clientY - rect.top);

    // Show loading indicator
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';
    document.getElementById('noResult').style.display = 'none';

    const formData = new FormData();
    formData.append('x', x);
    formData.append('y', y);
    formData.append('image_path', '{{ image_url|cut:"/media/" }}');

    fetch('', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      // Hide loading indicator
      document.getElementById('loading').style.display = 'none';
      
      // Show result
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      document.getElementById('noResult').style.display = 'none';
      
      resultDiv.querySelector('.color-preview').style.backgroundColor = data.hex_value;
      document.getElementById('colorName').innerText = data.detected_color;
      document.getElementById('rgbValue').innerText = data.rgb_value;
      document.getElementById('hexValue').innerText = data.hex_value;
    })
    .catch(err => {
      console.error("Error:", err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('noResult').style.display = 'block';
    });
  });
}

// Function to copy HEX value to clipboard
function copyToClipboard() {
  const hexValue = document.getElementById('hexValue').innerText;
  
  navigator.clipboard.writeText(hexValue).then(() => {
    // Show success message
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Copied!';
    button.classList.remove('from-primary-600', 'to-primary-700');
    button.classList.add('from-green-600', 'to-green-700');
    
    // Reset button after 2 seconds
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('from-green-600', 'to-green-700');
      button.classList.add('from-primary-600', 'to-primary-700');
    }, 2000);
  }).catch(err => {
    console.error('Could not copy text: ', err);
  });
}

// Add form-control class to Django form field
document.addEventListener('DOMContentLoaded', function() {
  const imageInput = document.querySelector('input[type="file"]');
  if (imageInput) {
    imageInput.classList.add('form-control');
  }
});
</script>
{% endblock %}